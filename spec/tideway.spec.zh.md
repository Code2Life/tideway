# SSE Gateway — 产品与技术规格

## 概述

实现一个简单的 **SSE 网关**：发布方（如 Web 服务器）通过 HTTP POST 将每个事件发送到网关；边缘端客户端通过 SSE 或 WebSocket 消费事件。

## 技术栈

- **运行时**：Hono + Cloudflare Workers + Cloudflare Durable Objects (DO)
- **工具链**：Wrangler（Miniflare 用于本地开发/调试）、Vite
- **管理后台**：React + Shadcn + Tailwind CSS 4

## 认证

| 角色       | 认证方式                               |
|------------|----------------------------------------|
| 订阅者     | 匿名（任意 HTTPS 客户端）              |
| 发布者     | API Key（网关支持多个 key，逗号分隔）  |

---

## 详细需求

### 1. 订阅者：主题选择与连接模型

- **建立 SSE 连接时**，客户端通过请求头 **`x-sse-topic`** 携带**逗号分隔**的主题名列表。
- 服务端根据该值：
  - 创建**单播**连接（新主题），或
  - 挂载到已有主题（多订阅者共享同一主题时即为**组播**）。

### 2. 连接生命周期与发布语义

**清理**

- 当连接断开时，若该主题下**剩余 SSE 连接数为 0**，则从连接映射（及任何相关路由状态）中移除该主题。

**发布**

- 发布请求**必须**包含请求头：**`x-sse-topic`**、**`x-sse-id`**（格式/规则与订阅者主题一致）。
- 若主题**无活跃连接**（瞬时主题不存在）：
  - **丢弃**该消息。
  - **记录**主题与 id 日志；**不要**读取请求体（保证性能）。
- “主题不存在”路径上设计为低延迟、最少处理。

### 3. 管理 API 与管理后台

**REST API**

- 连接的**分页列表**：RESTful，**单次请求最多 500 条**，支持分页参数。

**管理后台**

- **认证**：与发布者使用相同 API Key；在 **localStorage** 中保存为登录状态；每次请求在 header 中携带（如 `Authorization`）。
- **标签页**：Topics | Connections | Tail Events（Tail 需先选择主题）。
- **数据来源**：管理后台必须从 **Durable Object (DO)** 读取，以保证数据一致，不受 Worker 休眠或多副本影响。
- **技术栈**：React + Shadcn + Tailwind CSS 4；保持应用精简、聚焦。

### 4. 分布式部署与 Redis 适配器

- **Cloudflare**：使用 DO 存储状态；设计时兼顾性能与分布式。
- **非 Cloudflare**：提供 **Redis 适配器**，**模拟 DO API**，使同一套网关逻辑可在 CF 外运行。
  - 启动时各节点**上报自身身份**（IP/主机名）；支持通过环境变量覆盖（如对外宣告的 host）。
  - Redis 适配器必须**记录每个主题的连接分布在哪些节点**，以便只有某一节点收到 POST 时也能正确路由发布。
- **设计**：适配器**解耦**、可**单独做单元测试**。
- **部署方式**：
  - **Docker**：单份 compose（或等价）支持本地/分布式运行。
  - **Helm**：部署 **3 个 SSE Gateway 副本** + Redis（内置或外部）。

### 5. 文档与示例

- **文档**放在 `docs/`：从**入门**到**进阶参考**；以**用户视角**审视 API 与用法，必要时调整。
- **客户端示例**：TypeScript、Python、Go、Rust 的**发布者**与**订阅者**示例。
- **验证**：E2E 测试必须**运行上述示例**，并在真实网关上验证通过。

### 6. 质量与测试（高优先级）

- 设计与实现须突出**性能**与**分布式行为**；遵循最佳实践。
- **测试策略**：
  - 高价值的单元/集成测试。
  - **基准测试**（如吞吐、扇出、延迟）。
  - **E2E 测试**：使用 **Wrangler CLI** 部署 worker，在**真实**部署环境上运行测试；E2E **不得**绕过或 mock（若缺少环境/工具，应提出需求而非 mock）。
- **产出物**：结果持久化到：
  - `test-results/`
  - `benchmark-results/`
- 完成后结果须**可查阅、可对比**。

---

## 总结清单

- [ ] 通过 `x-sse-topic`（逗号分隔）进行 SSE/WebSocket 订阅；按主题区分单播与组播。
- [ ] 通过 POST 发布，携带 `x-sse-topic` 与 `x-sse-id`；主题无连接时丢弃并打日志；丢弃路径不读 body。
- [ ] 某主题最后一名订阅者断开时清理连接映射。
- [ ] REST API：分页连接列表（每页 ≤500）。
- [ ] 管理后台：API Key 认证（localStorage + header），标签 Topics | Connections | Tail Events，数据来自 DO。
- [ ] 非 CF 场景的 Redis 适配器；节点身份与 topic→节点 映射；Docker + Helm（3 个 GW + Redis）。
- [ ] 文档（入门 → 进阶）；TS/Python/Go/Rust 示例；E2E 验证。
- [ ] 测试 + 基准 + 对真实部署的 E2E；输出在 `test-results/` 与 `benchmark-results/`。
