services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: ["redis-server", "--save", "", "--appendonly", "no"]

  gateway-1:
    build:
      context: ..
      dockerfile: deploy/docker/gateway.Dockerfile
    environment:
      SSE_PUBLISHER_API_KEYS: ${SSE_PUBLISHER_API_KEYS:-dev-key}
      TIDEWAY_RUNTIME_ADAPTER: redis
      REDIS_URL: redis://redis:6379
      TIDEWAY_NODE_ID: gateway-1
      TIDEWAY_NODE_IP: gateway-1
    command: ["pnpm", "dev", "--ip", "0.0.0.0", "--port", "8787"]
    ports:
      - "8787:8787"
    depends_on:
      - redis

  gateway-2:
    build:
      context: ..
      dockerfile: deploy/docker/gateway.Dockerfile
    environment:
      SSE_PUBLISHER_API_KEYS: ${SSE_PUBLISHER_API_KEYS:-dev-key}
      TIDEWAY_RUNTIME_ADAPTER: redis
      REDIS_URL: redis://redis:6379
      TIDEWAY_NODE_ID: gateway-2
      TIDEWAY_NODE_IP: gateway-2
    command: ["pnpm", "dev", "--ip", "0.0.0.0", "--port", "8788"]
    ports:
      - "8788:8788"
    depends_on:
      - redis

  gateway-3:
    build:
      context: ..
      dockerfile: deploy/docker/gateway.Dockerfile
    environment:
      SSE_PUBLISHER_API_KEYS: ${SSE_PUBLISHER_API_KEYS:-dev-key}
      TIDEWAY_RUNTIME_ADAPTER: redis
      REDIS_URL: redis://redis:6379
      TIDEWAY_NODE_ID: gateway-3
      TIDEWAY_NODE_IP: gateway-3
    command: ["pnpm", "dev", "--ip", "0.0.0.0", "--port", "8789"]
    ports:
      - "8789:8789"
    depends_on:
      - redis
